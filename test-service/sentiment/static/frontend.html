<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAI Demonstrator Customer Review Sentiment</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="charty.css" />
</head>
<body style="margin: 0;">
<div id="app" style="width: 100%; max-width: 500px; margin: 0 auto;">
    <table style="margin: 0 auto;">
        <tr>
            <td><strong>XAI Demonstrator</strong></td>
        </tr>
        <tr>
            <td><textarea ref="input" id="input" style="width: 80vw; height: 25vh; font-size: 12pt;"></textarea></td>
        </tr>
        <tr>
            <td>
                <button v-on:click="onPredictButtonClick" style="width: 80vw; height: 8vh;">Predict</button>
            </td>
        </tr>
        <tr>
            <td>
                <button v-on:click="onExplainButtonClick" style="width: 80vw; height: 8vh;">Predict & Explain</button>
            </td>
        </tr>
        <tr>
            <td><strong>Sentiment:</strong> {{ sentiment }}</td>
        </tr>
        <tr>
            <td><strong>Explanation:</strong>

                <table data-id="flexbox-bar-graph" data-layout="horizontal">
                    <tbody>
                    <tr>
                        <td>
                            <span ref="bar1" style="--data-set:0;" class="positive"></span>
                        </td>
                        <td>
                            <span ref="bar2" style="--data-set:0;" class="positive"></span>
                        </td>
                        <td>
                            <span ref="bar3" style="--data-set:0;" class="positive"></span>
                        </td>
                    </tr>
                    <tr style="width: auto;">
                        <td>{{ word1 }}</td>
                        <td>{{ word2 }}</td>
                        <td>{{ word3 }}</td>
                    </tr>
                    </tbody>
                </table>

            </td>
        </tr>
    </table>

</div>
<script>
    new Vue({
        el: '#app',
        data() {
            return {
                explanation: null,
                sentiment: null,
                word1: "",
                word2: "",
                word3: ""
            }
        },
        methods: {
            onExplainButtonClick() {
                console.log(this.$refs.input.value)
                axios
                    .post('/explain', {"text": this.$refs.input.value})
                    .then(response => {
                        this.explanation = response.data.explanation.explanation
                        this.computeExplanation(this.explanation)
                        this.sentiment = "★".repeat(response.data.prediction.prediction.map((x, i) => [x, i]).reduce((r, a) => (a[0] > r[0] ? a : r))[1] + 1)
                    })
            },
            onPredictButtonClick() {
                console.log(this.$refs.input.value)
                axios
                    .post('/predict', {"text": this.$refs.input.value})
                    .then(response => {
                        this.explanation = ""
                        this.sentiment = "★".repeat(response.data.prediction.map((x, i) => [x, i]).reduce((r, a) => (a[0] > r[0] ? a : r))[1] + 1)
                    })
            },
            computeExplanation(unsorted_explanation) {
                console.log(unsorted_explanation)
                let explanation = unsorted_explanation.sort(function(a,b) {return Math.abs(b[1]) - Math.abs(a[1])})
                console.log(explanation)

                let score1 = explanation[0][1];
                let score2 = explanation[1][1];
                let score3 = explanation[2][1];

                this.$refs.bar1.style.setProperty('--data-set', score1)
                this.$refs.bar1.className = (score1 >= 0 ? "positive": "negative")

                this.$refs.bar2.style.setProperty('--data-set', score2)
                this.$refs.bar2.className = (score2 >= 0 ? "positive": "negative")

                this.$refs.bar3.style.setProperty('--data-set', score3)
                this.$refs.bar3.className = (score3 >= 0 ? "positive": "negative")

                this.word1 = explanation[0][0]
                this.word2 = explanation[1][0]
                this.word3 = explanation[2][0]
            }
        }
    })
</script>
</body>
</html>
