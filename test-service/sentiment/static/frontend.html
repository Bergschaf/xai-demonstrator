<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAI Demonstrator Customer Review Sentiment</title>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="charty.css"/>
</head>
<body style="margin: 0; font-family: sans-serif;">
<div id="app" style="width: 100%; max-width: 500px; margin: 0 auto;">
    <table style="margin: 0 0 auto;">
        <tr>
            <td><strong>XAI Demonstrator</strong>
                <p style="width: 80vw; font-size: smaller; text-align: justify;">Geben Sie ein Review ein. Sie können
                    beispielsweise Ihren letzten Restaurantbesuch oder einen Film bewerten.</p>
            </td>
        </tr>
        <tr>
            <td><textarea ref="input" id="input" style="width: 80vw; height: 25vh; font-size: 12pt;" :placeholder="[[ defaultReview ]]"></textarea></td>
        </tr>
        <tr>
            <td>
                <button v-on:click="onPredictButtonClick" style="width: 80vw; height: 8vh;">Liebe künstliche Intelligenz - wie viele Sterne sollte meine Bewertung kriegen?
                </button>
            </td>
        </tr>
        <tr>
            <td><strong>Bewertung:</strong> {{ sentiment }}</td>
        </tr>
        <tr>
            <td>
                <button v-on:click="onExplainButtonClick" style="width: 80vw; height: 8vh;">Kannst du diese Entscheidung begründen?</button>
            </td>
        </tr>

        <tr>
            <td><strong>Erklärung:</strong>

                <table data-id="flexbox-bar-graph" data-layout="horizontal">
                    <tbody>
                    <tr>
                        <td>
                            <span ref="bar1" style="--data-set:0; display: none;" class="positive"></span>
                        </td>
                        <td>
                            <span ref="bar2" style="--data-set:0; display: none;" class="positive"></span>
                        </td>
                        <td>
                            <span ref="bar3" style="--data-set:0; display: none;" class="positive"></span>
                        </td>
                    </tr>
                    <tr>
                        <td>{{ words[0] }}</td>
                        <td>{{ words[1] }}</td>
                        <td>{{ words[2] }}</td>
                    </tr>
                    </tbody>
                </table>

            </td>
        </tr>
        <tr>
            <td ref="highlight" style="width: 80vw;"><strong>Erklärung:</strong>&#32;<span v-for="word in explanation"><span v-bind:style="{'color': 'hsl(' + ((1 + 3*word[1]) * 60) + ',100%,' + ((word[1] === 0) ? 0 : 50) + '%)'}">{{word[0]}}&#32;</span></span></td>
        </tr>
    </table>

</div>
<script>
    new Vue({
        el: '#app',
        data() {
            return {
                explanation: null,
                sentiment: null,
                words: ["", "", ""],
                defaultReview: "Super Pizza und schneller Service - gerne bald wieder!!"
            }
        },
        methods: {
            onExplainButtonClick() {
                this.resetAll()
                this.explanation = ""

                console.log(this.$refs.input.value)
                if (!this.$refs.input.value) {
                    this.$refs.input.value = this.defaultReview
                }
                axios
                    .post('/explain', {"text": this.$refs.input.value})
                    .then(response => {
                        this.explanation = response.data.explanation.explanation
                        this.computeExplanation(this.explanation)
                        this.sentiment = "★".repeat(response.data.prediction.prediction.map((x, i) => [x, i]).reduce((r, a) => (a[0] > r[0] ? a : r))[1] + 1)
                    })
            },
            onPredictButtonClick() {
                this.resetAll()
                this.explanation = ""
                this.sentiment = ""

                console.log(this.$refs.input.value)
                if (!this.$refs.input.value) {
                    this.$refs.input.value = this.defaultReview
                }
                axios
                    .post('/predict', {"text": this.$refs.input.value})
                    .then(response => {
                        this.explanation = ""
                        this.sentiment = "★".repeat(response.data.prediction.map((x, i) => [x, i]).reduce((r, a) => (a[0] > r[0] ? a : r))[1] + 1)
                    })
            },
            computeExplanation(unsorted_explanation) {
                this.resetAll()

                console.log(unsorted_explanation)
                let explanation = [...unsorted_explanation].sort(function (a, b) {
                    return Math.abs(b[1]) - Math.abs(a[1])
                })
                console.log(explanation)

                let bars = [this.$refs.bar1, this.$refs.bar2, this.$refs.bar3]

                let len = Math.min(3, explanation.length)
                for (let i = 0; i < len; i++) {
                    console.log(explanation[i])
                    this.words[i] = explanation[i][0]
                    if (Math.abs(explanation[i][1]) > 0.0) {
                        bars[i].style.setProperty('--data-set', explanation[i][1])
                        bars[i].style.setProperty('display', 'inline')
                        bars[i].className = (explanation[i][1] >= 0 ? "positive" : "negative")
                    }
                }

                console.log(this.words)
            },
            resetAll() {
                this.words = ["", "", ""]

                let bars = [this.$refs.bar1, this.$refs.bar2, this.$refs.bar3]

                for (let bar of bars) {
                    bar.style.setProperty('--data-set', 0.0)
                    bar.style.setProperty('display', 'none')
                    bar.className = "positive"
                }

            }
        }
    })
</script>
</body>
</html>
