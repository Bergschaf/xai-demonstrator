name: Prod Deployment Sentiment

on:
  workflow_run:
    workflows:
      - "Landing Page"
      - "Review Sentiment"
      - "Visual Inspection"
    branches:
      - master
    types:
      - completed
  push:
    branches:
      - master

jobs:
  
  build-image-and-push-to-gcr:
    runs-on: ubuntu-latest
    steps:
    - name: Build Image and Push to GCR
      uses: raccoondev/push-docker-gcr@v1
      with:
        gcr_host: eu.gcr.io
        image_name: review-sentiment
        image_tag: latest
      env:
        GCLOUD_SERVICE_KEY: ${{ secrets.GCP_TEST_SA_KEY }}
        GOOGLE_PROJECT_ID: ${{ secrets.GCP_TEST_PROJECT_ID }}
    
  deploy-to-cloudrun:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy to Cloud Run
      id: deploy
      uses: google-github-actions/deploy-cloudrun@v0.2.0
      with:
        image: gcr.io/xai-demonstrator-test/review-sentiment:latest
        service: review-sentiment
        credentials: ${{ secrets.GCP_TEST_SA_KEY }}

    - name: Show Output
      run: echo ${{ steps.deploy.outputs.url }}
